<!--
 * @Author: Marlon.M
 * @Email: maiguangyang@163.com
 * @Date: 2024-08-06 07:06:08
-->
# 开发文档

- git clone 代码后，记得执行一次：`make install`

## 目录结构

```
lib/
├── core/                     # 基础设施层
│   ├── abstracts/            # 组件抽象基类（CustomStateless/StatefulWidget）
│   ├── config/               # 项目配置（多客户端白牌）
│   ├── enums/                # 全局枚举
│   ├── errors/               # 异常类和错误映射
│   ├── extensions/           # Dart 扩展方法
│   ├── l10n/                 # 国际化配置（18 种语言）
│   ├── middleware/           # 路由中间件（权限控制）
│   ├── mixins/               # 通用 Mixin（PaginationMixin）
│   ├── network/              # 网络层（Dio + 拦截器）
│   ├── providers/            # 全局 Provider
│   ├── theme/                # 主题系统
│   └── utils/                # 工具类
├── routing/                  # 路由配置
│   ├── route_path.dart       # 路由路径常量
│   ├── routes.dart           # FlutterRouter 路由列表
│   ├── router.dart           # GoRouter 配置
│   └── navigator_keys.dart   # NavigatorKey
├── shared/                   # 共享层（跨 Feature）
│   ├── application/          # 共享业务逻辑
│   │   ├── notifiers/        # 全局状态管理
│   │   └── providers/        # Provider 注入
│   ├── data/                 # 共享数据层
│   │   ├── models/           # 数据模型
│   │   ├── repositories/     # 仓库
│   │   ├── services/api/     # API 服务
│   │   └── mock/             # Mock 数据
│   ├── constants/            # 全局常量
│   └── widgets/              # 共享组件
├── features/                 # Feature 模块
│   └── xxx_screen/           # 每个 Feature 结构一致
│       ├── application/      # Feature 专属逻辑
│       ├── data/             # Feature 专属数据
│       └── ui/               # UI 层（desktop + mobile）
├── app.dart                  # App 根组件
├── bootstrap.dart            # 启动初始化
└── main.dart                 # 入口文件
```

### 辅助命令
- 修改 Entity 后，执行代码生成：`make code`
- 修改 `lib/core/l10n/language.json` 后，执行 `make l10n`
- 修改 `assets/fonts/*` 后，执行 `make icon`
- 测试 [常用断言类型](./test.md)


## 项目架构

### 数据流

```
UI Event → Notifier → Repository → ApiService → 后端 API
State Change ← Notifier ← Repository ← ApiService ← 后端 API
```

### 分层说明

- **Core 层**：基础设施。提供网络、主题、国际化、错误处理等基础能力，不含任何业务逻辑。所有 Feature 和 Shared 都可以依赖 Core。

- **Shared 层**：跨 Feature 共享的业务。包含全局状态管理（Auth、User、Menu 等 Notifier）、全局数据层（Model、Repository、API Service）和共享 UI 组件。

- **Feature 层**：独立功能模块。每个 Feature 内部统一分为：
  - `application/` — 业务逻辑，通过 Notifier 管理状态，通过 Provider 注入依赖
  - `data/` — Feature 独有的数据（模型、仓库、接口），共享数据则放 `shared/data/`
  - `ui/` — UI 组件，分 `desktop/` 和 `mobile/` 两端平台适配

### Shared 与 Feature 的 application / data 使用场景对比

| 维度 | `shared/` | `features/xxx_screen/` |
|------|-----------|------------------------|
| **作用域** | 全局，跨 Feature 共享 | 仅限当前 Feature 内部使用 |
| **application/notifiers** | 全局状态（Auth、User、Menu、Download 等） | 页面专属状态（如 OrderFormNotifier） |
| **application/providers** | 全局依赖注入（Repository、Service 等） | 页面专属依赖注入 |
| **data/models** | 通用模型（UserEntity、BaseEntity、PageRequest） | 页面独有模型（如 OrderDetailEntity） |
| **data/repositories** | 通用仓库（AuthRepository、UserRepository） | 页面独有仓库（如 OrderRepository） |
| **data/services** | 通用 API（AuthApiService、UserApiService） | 页面独有 API（如 OrderApiService） |
| **判断标准** | ≥ 2 个 Feature 会用到 → 放 shared | 只有当前 Feature 用 → 放 feature |

**举例：**
- `UserEntity` → 多处使用（登录、首页、设置）→ 放 `shared/data/models/`
- `OrderDetailEntity` → 仅订单页使用 → 放 `features/order_screen/data/models/`
- `AuthNotifier`（登录状态）→ 全局共享 → 放 `shared/application/notifiers/`
- `OrderFormNotifier`（订单表单）→ 仅订单页使用 → 放 `features/order_screen/application/notifiers/`

### 各层职责

| 层级 | 组件 | 职责 |
|------|------|------|
| **Application** | Notifier | 管理可变状态，承载业务逻辑，调用 Repository |
| **Application** | Provider | 提供不可变的依赖注入（Repository、Service 等） |
| **Data** | Model/Entity | 数据结构定义，纯数据，无副作用 |
| **Data** | Repository | 聚合 API Service，屏蔽数据来源（网络/缓存），输出 Entity |
| **Data** | ApiService | 底层 HTTP 调用，DTO 序列化/反序列化 |
| **UI** | Widget | 页面和组件，通过 `ref.watch` 监听 Notifier 状态 |

## 依赖原则

- Entity/Model 必须独立，不依赖任何外部包
- Application 层可以依赖 Data 层（Repository、Model）
- UI 层通过 Provider 获取 Notifier，不直接调用 Repository
- Feature 之间互不依赖，共享逻辑放 `shared/`
- 所有层都可以依赖 `core/`

## 架构优势

- **清晰的分层结构**：Core / Shared / Features 职责分明，利于代码组织和维护
- **高内聚低耦合**：Feature 之间互不依赖，通过 Shared 层共享数据
- **平台适配**：UI 层分 desktop / mobile，代码隔离清晰
- **可扩展性**：新增 Feature 只需按模板创建 application/data/ui 三个目录
- **可测试性**：分层清晰，各层级依赖通过 Provider 注入，方便 Mock
- **白牌支持**：通过 Config 系统支持多客户端定制
